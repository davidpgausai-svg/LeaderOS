<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - StrategicFlow</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-brand">StrategicFlow</div>
    <div class="nav-user">
      <span id="userEmail" data-testid="text-user-email"></span>
      <button id="logoutBtn" class="btn btn-secondary" data-testid="button-logout">Logout</button>
    </div>
  </nav>
  
  <div class="dashboard-container">
    <aside class="sidebar">
      <h3>Navigation</h3>
      <ul class="nav-list">
        <li><a href="#strategies" class="nav-item active" data-section="strategies" data-testid="link-strategies">Strategies</a></li>
        <li><a href="#projects" class="nav-item" data-section="projects" data-testid="link-projects">Projects</a></li>
        <li><a href="#actions" class="nav-item" data-section="actions" data-testid="link-actions">Actions</a></li>
      </ul>
    </aside>
    
    <main class="main-content">
      <section id="strategies-section" class="section active">
        <div class="section-header">
          <h2>Strategies</h2>
          <button id="addStrategyBtn" class="btn btn-primary" data-testid="button-add-strategy">+ Add Strategy</button>
        </div>
        <div id="strategiesList" class="list" data-testid="list-strategies"></div>
      </section>
      
      <section id="projects-section" class="section">
        <div class="section-header">
          <h2>Projects</h2>
          <button id="addProjectBtn" class="btn btn-primary" data-testid="button-add-project">+ Add Project</button>
        </div>
        <div id="projectsList" class="list" data-testid="list-projects"></div>
      </section>
      
      <section id="actions-section" class="section">
        <div class="section-header">
          <h2>Actions</h2>
          <button id="addActionBtn" class="btn btn-primary" data-testid="button-add-action">+ Add Action</button>
        </div>
        <div id="actionsList" class="list" data-testid="list-actions"></div>
      </section>
    </main>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 id="modalTitle"></h3>
      <form id="modalForm">
        <div id="modalFields"></div>
        <button type="submit" class="btn btn-primary" data-testid="button-modal-submit">Save</button>
      </form>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    
    if (!token) {
      window.location.href = '/login';
    }
    
    document.getElementById('userEmail').textContent = user.email || '';
    
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/login';
    });

    const headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    };

    async function fetchData(endpoint) {
      const res = await fetch(`/api/${endpoint}`, { headers });
      if (res.status === 401) {
        localStorage.removeItem('token');
        window.location.href = '/login';
        return [];
      }
      return res.json();
    }

    async function postData(endpoint, data) {
      const res = await fetch(`/api/${endpoint}`, {
        method: 'POST',
        headers,
        body: JSON.stringify(data)
      });
      return res.json();
    }

    async function deleteData(endpoint, id) {
      await fetch(`/api/${endpoint}/${id}`, { method: 'DELETE', headers });
    }

    async function loadStrategies() {
      const strategies = await fetchData('strategies');
      const list = document.getElementById('strategiesList');
      list.innerHTML = strategies.map(s => `
        <div class="list-item" data-testid="item-strategy-${s.id}">
          <div class="item-content">
            <h4>${s.name}</h4>
            <p>${s.description || 'No description'}</p>
            <span class="badge ${s.status}">${s.status}</span>
          </div>
          <button class="btn btn-danger btn-sm" onclick="deleteStrategy('${s.id}')" data-testid="button-delete-strategy-${s.id}">Delete</button>
        </div>
      `).join('') || '<p class="empty">No strategies yet</p>';
    }

    async function loadProjects() {
      const projects = await fetchData('projects');
      const list = document.getElementById('projectsList');
      list.innerHTML = projects.map(p => `
        <div class="list-item" data-testid="item-project-${p.id}">
          <div class="item-content">
            <h4>${p.name}</h4>
            <span class="badge ${p.status}">${p.status}</span>
          </div>
          <button class="btn btn-danger btn-sm" onclick="deleteProject('${p.id}')" data-testid="button-delete-project-${p.id}">Delete</button>
        </div>
      `).join('') || '<p class="empty">No projects yet</p>';
    }

    async function loadActions() {
      const actions = await fetchData('actions');
      const list = document.getElementById('actionsList');
      list.innerHTML = actions.map(a => `
        <div class="list-item" data-testid="item-action-${a.id}">
          <div class="item-content">
            <p>${a.description}</p>
            <span class="badge ${a.status}">${a.status}</span>
          </div>
          <button class="btn btn-danger btn-sm" onclick="deleteAction('${a.id}')" data-testid="button-delete-action-${a.id}">Delete</button>
        </div>
      `).join('') || '<p class="empty">No actions yet</p>';
    }

    async function deleteStrategy(id) {
      if (confirm('Delete this strategy?')) {
        await deleteData('strategies', id);
        loadStrategies();
      }
    }

    async function deleteProject(id) {
      if (confirm('Delete this project?')) {
        await deleteData('projects', id);
        loadProjects();
      }
    }

    async function deleteAction(id) {
      if (confirm('Delete this action?')) {
        await deleteData('actions', id);
        loadActions();
      }
    }

    const modal = document.getElementById('modal');
    const modalForm = document.getElementById('modalForm');
    let currentModalType = '';

    document.querySelector('.close').addEventListener('click', () => {
      modal.style.display = 'none';
    });

    window.addEventListener('click', (e) => {
      if (e.target === modal) modal.style.display = 'none';
    });

    document.getElementById('addStrategyBtn').addEventListener('click', () => {
      currentModalType = 'strategy';
      document.getElementById('modalTitle').textContent = 'Add Strategy';
      document.getElementById('modalFields').innerHTML = `
        <div class="form-group">
          <label for="name">Name</label>
          <input type="text" id="name" name="name" required data-testid="input-strategy-name">
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" data-testid="input-strategy-description"></textarea>
        </div>
      `;
      modal.style.display = 'block';
    });

    document.getElementById('addProjectBtn').addEventListener('click', async () => {
      currentModalType = 'project';
      const strategies = await fetchData('strategies');
      document.getElementById('modalTitle').textContent = 'Add Project';
      document.getElementById('modalFields').innerHTML = `
        <div class="form-group">
          <label for="strategy_id">Strategy</label>
          <select id="strategy_id" name="strategy_id" required data-testid="select-strategy">
            ${strategies.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label for="name">Name</label>
          <input type="text" id="name" name="name" required data-testid="input-project-name">
        </div>
      `;
      modal.style.display = 'block';
    });

    document.getElementById('addActionBtn').addEventListener('click', async () => {
      currentModalType = 'action';
      const projects = await fetchData('projects');
      document.getElementById('modalTitle').textContent = 'Add Action';
      document.getElementById('modalFields').innerHTML = `
        <div class="form-group">
          <label for="project_id">Project</label>
          <select id="project_id" name="project_id" required data-testid="select-project">
            ${projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" required data-testid="input-action-description"></textarea>
        </div>
      `;
      modal.style.display = 'block';
    });

    modalForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(modalForm);
      const data = Object.fromEntries(formData.entries());

      if (currentModalType === 'strategy') {
        await postData('strategies', data);
        loadStrategies();
      } else if (currentModalType === 'project') {
        await postData('projects', data);
        loadProjects();
      } else if (currentModalType === 'action') {
        await postData('actions', data);
        loadActions();
      }

      modal.style.display = 'none';
      modalForm.reset();
    });

    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        
        item.classList.add('active');
        const section = item.dataset.section;
        document.getElementById(`${section}-section`).classList.add('active');
      });
    });

    loadStrategies();
    loadProjects();
    loadActions();
  </script>
</body>
</html>
